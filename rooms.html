<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Salles | Smart Light System</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="assets/custom.css">
</head>
<body>
<div class="d-flex">
  <div id="sidebar-container"></div>
  <main class="flex-fill p-4 bg-light">

    <div class="page-header">
      <h4>üö™ Gestion des Salles</h4>
      <button class="btn btn-primary" onclick="openModal()">+ Ajouter Salle</button>
    </div>

    <div class="filter-bar">
      <input type="text" id="search" placeholder="üîç Rechercher une salle..." oninput="render()" style="flex:1;min-width:180px;">
      <select id="filter-building" onchange="render()">
        <option value="">Tous les b√¢timents</option>
      </select>
    </div>

    <div class="card">
      <table class="table mb-0">
        <thead style="background:#1a1a2e;color:#fff;">
          <tr>
            <th style="padding:14px 16px;border:none;">Salle</th>
            <th style="padding:14px 16px;border:none;">B√¢timent</th>
            <th style="padding:14px 16px;border:none;">Lampes</th>
            <th style="padding:14px 16px;border:none;">Actions group√©es</th>
            <th style="padding:14px 16px;border:none;">Actions</th>
          </tr>
        </thead>
        <tbody id="rooms-body"></tbody>
      </table>
    </div>

  </main>
</div>

<!-- Modal -->
<div id="modal" style="display:none;" class="modal-backdrop-custom">
  <div class="modal-box">
    <h5 id="modal-title">Ajouter une Salle</h5>
    <input type="hidden" id="edit-id">
    <div class="mb-3">
      <label class="form-label">Nom de la salle *</label>
      <input type="text" id="f-name" class="form-control" placeholder="ex: Salle 201">
    </div>
    <div class="mb-3">
      <label class="form-label">B√¢timent *</label>
      <select id="f-building" class="form-select"></select>
    </div>
    <div class="modal-footer-btns">
      <button class="btn btn-secondary btn-sm" onclick="closeModal()">Annuler</button>
      <button class="btn btn-primary btn-sm" onclick="saveRoom()">Enregistrer</button>
    </div>
  </div>
</div>

<script src="js/app.js"></script>
<script src="js/buildings.js"></script>
<script src="js/rooms.js"></script>
<script src="js/lights.js"></script>
<script src="js/history.js"></script>
<script src="js/users.js"></script>

<script>
  if (!APP.currentUser) window.location.href = 'index.html';
  document.getElementById('sidebar-container').innerHTML = getSidebar('rooms.html');

  function populateBuildingFilters() {
    const sel = document.getElementById('filter-building');
    const cur = sel.value;
    sel.innerHTML = '<option value="">Tous les b√¢timents</option>' +
      APP.state.buildings.map(b => `<option value="${b.id}">${b.name}</option>`).join('');
    sel.value = cur;

    const fsel = document.getElementById('f-building');
    if (fsel) fsel.innerHTML = APP.state.buildings.map(b => `<option value="${b.id}">${b.name}</option>`).join('');
  }

  function render() {
    populateBuildingFilters();
    const search = document.getElementById('search').value.toLowerCase();
    const bFilter = parseInt(document.getElementById('filter-building').value);

    let rooms = APP.state.rooms;
    if (bFilter) rooms = rooms.filter(r => r.buildingId === bFilter);
    if (search) rooms = rooms.filter(r => r.name.toLowerCase().includes(search));

    const tbody = document.getElementById('rooms-body');
    if (rooms.length === 0) {
      tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted py-4">Aucune salle trouv√©e.</td></tr>';
      return;
    }

    tbody.innerHTML = rooms.map(r => {
      const building = APP.state.buildings.find(b => b.id === r.buildingId);
      const lights = APP.state.lights.filter(l => l.roomId === r.id);
      const onCount = lights.filter(l => l.on).length;
      return `<tr>
        <td style="padding:14px 16px;font-weight:600;">${r.name}</td>
        <td style="padding:14px 16px;color:#6b7280;">${building ? building.name : '‚Äî'}</td>
        <td style="padding:14px 16px;">
          <span class="badge-on">${onCount} ON</span>
          <span class="badge-off">${lights.length - onCount} OFF</span>
          <span style="font-size:.78rem;color:#6b7280;margin-left:4px;">(${lights.length} total)</span>
        </td>
        <td style="padding:14px 16px;">
          <button class="btn btn-sm btn-success me-1" onclick="groupAction(${r.id},'ON')">üí° ON</button>
          <button class="btn btn-sm btn-secondary" onclick="groupAction(${r.id},'OFF')">üîå OFF</button>
        </td>
        <td style="padding:14px 16px;">
          <button class="btn btn-sm btn-warning me-1" onclick="openModal(${r.id})">‚úèÔ∏è √âditer</button>
          <button class="btn btn-sm btn-danger" onclick="deleteRoom(${r.id})">üóë Suppr.</button>
        </td>
      </tr>`;
    }).join('');
  }

  function openModal(id) {
    document.getElementById('edit-id').value = id || '';
    populateBuildingFilters();
    if (id) {
      const r = APP.state.rooms.find(r => r.id === id);
      document.getElementById('modal-title').textContent = 'Modifier la Salle';
      document.getElementById('f-name').value = r.name;
      document.getElementById('f-building').value = r.buildingId;
    } else {
      document.getElementById('modal-title').textContent = 'Ajouter une Salle';
      document.getElementById('f-name').value = '';
    }
    document.getElementById('modal').style.display = 'flex';
  }

  function closeModal() { document.getElementById('modal').style.display = 'none'; }

  function saveRoom() {
    const name = document.getElementById('f-name').value.trim();
    const buildingId = parseInt(document.getElementById('f-building').value);
    if (!name) { showToast('Le nom est obligatoire','warning'); return; }
    if (!buildingId) { showToast('S√©lectionnez un b√¢timent','warning'); return; }
    const id = document.getElementById('edit-id').value;
    if (id) {
      const r = APP.state.rooms.find(r => r.id === parseInt(id));
      r.name = name; r.buildingId = buildingId;
      showToast('Salle modifi√©e avec succ√®s');
    } else {
      APP.state.rooms.push({ id: APP.state.nextId.rooms++, name, buildingId });
      showToast('Salle ajout√©e avec succ√®s');
    }
    APP.save(); closeModal(); render();
  }

  function deleteRoom(id) {
    const r = APP.state.rooms.find(r => r.id === id);
    confirmAction(`Supprimer "<strong>${r.name}</strong>" et ses lampes ?`, () => {
      APP.state.lights = APP.state.lights.filter(l => l.roomId !== id);
      APP.state.rooms = APP.state.rooms.filter(r => r.id !== id);
      APP.save(); showToast('Salle supprim√©e','danger'); render();
    });
  }

  function groupAction(roomId, action) {
    let count = 0;
    APP.state.lights.forEach(l => {
      if (l.roomId === roomId) {
        const shouldBe = action === 'ON';
        if (l.on !== shouldBe) { APP.toggleLight(l.id); count++; }
      }
    });
    showToast(`${count} lampe(s) ${action === 'ON' ? 'allum√©e(s)' : '√©teinte(s)'}`, 'success');
    render();
  }

  document.getElementById('modal').addEventListener('click', e => {
    if (e.target === document.getElementById('modal')) closeModal();
  });

  render();
</script>
</body>
</html>