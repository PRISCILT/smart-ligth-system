<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Historique | Smart Light System</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="assets/custom.css">
</head>
<body>
<div class="d-flex">
  <div id="sidebar-container"></div>
  <main class="flex-fill p-4 bg-light">

    <div class="page-header">
      <div>
        <h4>ðŸ“‹ Historique des actions</h4>
        <small style="color:#6b7280;" id="count-msg"></small>
      </div>
      <button class="btn btn-sm btn-danger" onclick="clearHistory()">ðŸ—‘ Effacer tout</button>
    </div>

    <div class="filter-bar">
      <input type="text" id="search" placeholder="ðŸ” Rechercher lampe / utilisateur..." oninput="render()" style="flex:1;min-width:180px;">
      <select id="filter-action" onchange="render()">
        <option value="">Toutes actions</option>
        <option value="ON">ON uniquement</option>
        <option value="OFF">OFF uniquement</option>
      </select>
      <input type="date" id="filter-date" onchange="render()">
      <select id="filter-user" onchange="render()">
        <option value="">Tous utilisateurs</option>
      </select>
    </div>

    <div class="card">
      <table class="table mb-0">
        <thead style="background:#1a1a2e;color:#fff;">
          <tr>
            <th style="padding:14px 16px;border:none;">Date / Heure</th>
            <th style="padding:14px 16px;border:none;">Lampe</th>
            <th style="padding:14px 16px;border:none;">Action</th>
            <th style="padding:14px 16px;border:none;">Utilisateur</th>
          </tr>
        </thead>
        <tbody id="history-body"></tbody>
      </table>
    </div>

  </main>
</div>

<script src="js/app.js"></script>
<script>
  if (!APP.currentUser) window.location.href = 'index.html';
  document.getElementById('sidebar-container').innerHTML = getSidebar('history.html');

  function render() {
    // Populate user filter
    const users = [...new Set(APP.state.history.map(h => h.user))];
    const fu = document.getElementById('filter-user');
    const cuv = fu.value;
    fu.innerHTML = '<option value="">Tous utilisateurs</option>' + users.map(u => `<option value="${u}">${u}</option>`).join('');
    fu.value = cuv;

    const search = document.getElementById('search').value.toLowerCase();
    const actionF = document.getElementById('filter-action').value;
    const dateF = document.getElementById('filter-date').value;
    const userF = document.getElementById('filter-user').value;

    let history = APP.state.history;
    if (search) history = history.filter(h => h.lightName.toLowerCase().includes(search) || h.user.toLowerCase().includes(search));
    if (actionF) history = history.filter(h => h.action === actionF);
    if (userF) history = history.filter(h => h.user === userF);
    if (dateF) {
      const d = new Date(dateF);
      history = history.filter(h => {
        const hd = new Date(h.timestamp);
        return hd.toDateString() === d.toDateString();
      });
    }

    document.getElementById('count-msg').textContent = `${history.length} action(s) trouvÃ©e(s)`;

    const tbody = document.getElementById('history-body');
    if (history.length === 0) {
      tbody.innerHTML = '<tr><td colspan="4" class="text-center text-muted py-5">Aucun historique trouvÃ©.</td></tr>';
      return;
    }

    tbody.innerHTML = history.map(h => `
      <tr>
        <td style="padding:12px 16px;font-family:'Space Mono',monospace;font-size:.82rem;color:#6b7280;">${APP.formatDate(h.timestamp)}</td>
        <td style="padding:12px 16px;font-weight:600;">${h.lightName}</td>
        <td style="padding:12px 16px;">
          ${h.action === 'ON'
            ? '<span class="badge-on">âœ… ON</span>'
            : '<span class="badge-off">â¬œ OFF</span>'}
        </td>
        <td style="padding:12px 16px;color:#6b7280;">${h.user}</td>
      </tr>`).join('');
  }

  function clearHistory() {
    confirmAction('Effacer tout l\'historique ?', () => {
      APP.state.history = [];
      APP.save();
      showToast('Historique effacÃ©','danger');
      render();
    });
  }

  render();
</script>
</body>
</html>